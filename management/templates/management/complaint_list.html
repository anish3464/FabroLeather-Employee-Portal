<!DOCTYPE html>
<html lang="en">
{% include 'management/base.html'%}
<head>
    <meta charset="UTF-8">
    <title>Customer Complaints Log</title>
        <style>
        body {
            background-color: #1e1e2f;
            color: #f5f5f5;
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #2b2b3c;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #444;
            text-align: left;
        }
        th {
            background-color: #3a3a4f;
        }
        input[type="text"] {
            width: 300px;
            padding: 8px;
            margin: 20px 0;
            border-radius: 5px;
            border: none;
        }
        .thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 5px;
        }
        .media-row {
            display: flex;
            flex-wrap: wrap;
        }
        .modal {
        display: none;
        position: fixed;
        z-index: 1050;
        padding-top: 40px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: #1a1a1a; /* solid dark background */
        }

        .modal-content {
            background-color: #2b2b3c;  /* dark content box */
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            z-index: 1060;
            width: 80%;
            max-width: 1000px;
            text-align: left; /* align content to the left */
            color: #f5f5f5;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }  
        .filter-bar {
            position: sticky;
            top: 0;
            z-index: 500;
            background-color: #2a2a3d;
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .filter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: center;
        }

        .filter-form input,
        .filter-form select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #1e1e2f;
            color: #fff;
        }

        .filter-form .apply-btn {
            background-color: #4f8cff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .filter-form .clear-btn {
            background-color: #ff4f4f;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
        }
        .add-complaint {
            text-align: right;
            margin: 20px;
            color:rgb(168, 142, 142);
        }
        .clear-btn {
            background-color: #ff4f4f;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            text-decoration: none;
        }
        .add-btn {
            background-color: #4f8cff;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
        }
        .add-btn:hover, .clear-btn:hover, .apply-btn:hover {
            opacity: 0.8;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .action-buttons button, .action-buttons a {
            background-color: #4f8cff;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            border: none;
            cursor: pointer;
        }
        
      
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    
    <div style="display: flex;", "flex-direction: column; align-items: center; justify-content: center; margin-top: 20px;">
    <h1>Complaint List</h1>
    <div style="display: flex; gap: 20px;">
        <div style="width: 150px; height: 150px; position: relative;">
            <canvas id="statusChart" width="150" height="150"></canvas>
        </div>
        <div style="width: 150px; height: 150px; position: relative;">
            <canvas id="caseTypeChart" width="150" height="150"></canvas>
        </div>
        <div style="width: 150px; height: 150px; position: relative;">
            <canvas id="countryChart" width="150" height="150"></canvas>
        </div>    
    </div>
    </div>


    <div class="add-complaint">
        <a href="{% url 'add_complaint' %}" class="add-btn">Add Complaint</a>
    </div>
    <div class="filter-bar">
   <form id="filter-form" method="GET">
        <input type="text" name="search" placeholder="Search..." value="{{ search_query }}">

        <select name="search_by">
            <option value="complaint_id" {% if search_by == 'complaint_id' %}selected{% endif %}>Complaint ID</option>
            <option value="batch_order" {% if search_by == 'batch_order' %}selected{% endif %}>Batch Order</option>
            <option value="complaint_description" {% if search_by == 'complaint_description' %}selected{% endif %}>Description</option>
            <option value="justification_from_factory" {% if search_by == 'justification_from_factory' %}selected{% endif %}>Justification</option>
            <option value="action_from_factory" {% if search_by == 'action_from_factory' %}selected{% endif %}>Action</option>
            <option value="series" {% if search_by == 'series' %}selected{% endif %}>Series</option>
            <option value="material" {% if search_by == 'material' %}selected{% endif %}>Material</option>            
        </select>


    
    <select name="case_type">
        <option value="">All Case Types</option>
        {% for case_type in case_types %}
            <option value="{{ case_type.id }}" {% if selected_case_type == case_type.id|stringformat:"s" %}selected{% endif %}>
                {{ case_type.name }}
            </option>
        {% endfor %}
    </select>

    <select name="channel">
        <option value="">All Channels</option>
        {% for channel in channels %}
            <option value="{{ channel.id }}" {% if selected_channel == channel.id|stringformat:"s" %}selected{% endif %}>
                {{ channel.name }}
            </option>
        {% endfor %}
    </select>

    <select name="person">
        <option value="">All Persons</option>
        {% for person in persons %}
            <option value="{{ person.id }}" {% if selected_person == person.id|stringformat:"s" %}selected{% endif %}>
                {{ person.name }}
            </option>
        {% endfor %}
    </select>

    <select name="country">
        <option value="">All Countries</option>
        {% for country in countries %}
            <option value="{{ country.id }}" {% if selected_country == country.id|stringformat:"s" %}selected{% endif %}>
                {{ country.name }}
            </option>
        {% endfor %}
    </select>

    <select name="status">
        <option value="">All Statuses</option>
        {% for status in statuses %}
            <option value="{{ status }}" {% if selected_status == status %}selected{% endif %}>{{ status }}</option>
        {% endfor %}
    </select>

    <input type="date" name="from_date" value="{{ from_date }}">
    <input type="date" name="to_date" value="{{ to_date }}">
    <button type="submit" class="apply-btn">Apply Filters</button>    
    <a href="{% url 'complaint_list' %}" class="clear-btn">Clear</a>
    </form>
</div>

    <table>
        <thead>
            <tr>
            <th>Sl. No.</th>    
            <th>ID</th>
            <th>Date</th>
            <th>Channel</th>
            <th>Country</th>
            <th>Case Type</th>
            <th>Person</th>
            <th>Series</th>
            <th>Material</th>
            <th>Brand</th>
            <th>Model</th>
            <th>Sub-Model</th>
            <th>Year</th>
            <th>Action</th>
            <th>Justification</th>
            <th>Description</th>
            <th>Batch Order</th>
            <th>Status</th>
            <th>Media Files</th>
            <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for complaint in complaints %}
            <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ complaint.complaint_id }}</td>
            <td>{{ complaint.date }}</td>
            <td>{{ complaint.channel }}</td>
            <td>{{ complaint.country }}</td>
            <td>{{ complaint.case_type }}</td>
            <td>{{ complaint.person }}</td>
            <td>{{ complaint.series }}</td>
            <td>{{ complaint.material }}</td>
            <td>{{ complaint.brand }}</td>
            <td>{{ complaint.model }}</td>
            <td>{{ complaint.sub_model|default:'-'}}</td>
            <td>{{ complaint.year }}</td>
            <td>{{ complaint.action_from_factory }}</td>
            <td>{{ complaint.justification_from_factory }}</td>
            <td>{{ complaint.complaint_description }}</td>
            <td>{{ complaint.batch_order }}</td>
            <td>{{ complaint.status }}</td>
            <td>{{ complaint.media_files.count }} file(s)</td>
            <td class="action-buttons">
                <button onclick="openModal('{{ complaint.complaint_id }}')">View</button>
                <a href="{% url 'edit_complaint' complaint.complaint_id %}" class="action-btn">Edit</a>
                <a href="{% url 'delete_complaint' complaint.complaint_id %}" class="action-btn" onclick="return confirm('Are you sure you want to delete this complaint?');">Delete</a>
            </td>
            </tr>
            <div id="modal-{{ complaint.complaint_id }}" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('{{ complaint.complaint_id }}')">&times;</span>
                <h2>Complaint {{ complaint.complaint_id }}</h2>
                <p><strong>Date:</strong> {{ complaint.date }}</p>
                <p><strong>Channel:</strong> {{ complaint.channel }}</p>
                <p><strong>Country:</strong> {{ complaint.country }}</p>
                <p><strong>Person:</strong> {{ complaint.person }}</p>
                <p><strong>Case Type:</strong> {{ complaint.case_type }}</p>
                <p><strong>Series:</strong> {{ complaint.series }}</p>
                <p><strong>Material:</strong> {{ complaint.material }}</p>
                <p><strong>Brand:</strong> {{ complaint.brand }}</p>
                <p><strong>Model:</strong> {{ complaint.model }}</p>
                <p><strong>Sub-Model:</strong> {{ complaint.sub_model|default:"-" }}</p>
                <p><strong>Year:</strong> {{ complaint.year }}</p>
                <p><strong>Description:</strong> {{ complaint.complaint_description }}</p>
                <p><strong>Factory Justification:</strong> {{ complaint.justification_from_factory }}</p>
                <p><strong>Factory Action:</strong> {{ complaint.action_from_factory }}</p>
                <p><strong>Batch Order:</strong> {{ complaint.batch_order }}</p>
                <p><strong>Status:</strong> {{ complaint.status }}</p>
                <p><strong>Media Files:</strong> {{ complaint.media_files.count }} file(s)</p>
                
                {% if complaint.media_files.count == 0 %}
                    <p>No media files available.</p>
                {% endif %}
                <h3>Images</h3>
                <div class="media-row">
                    {% for media in complaint.media_files.all %}
                        {% if ".jpg" in media.file.url|lower or ".jpeg" in media.file.url|lower or ".png" in media.file.url|lower %}
                            <img src="{{ media.file.url }}" class="thumbnail" onclick="enlargeImage(this.src)">
                        {% endif %}
                    {% endfor %}
                </div>

                <h3 style="margin-top: 20px;">Videos</h3>
                <div class="media-row">
                    {% for media in complaint.media_files.all %}
                        {% if ".mp4" in media.file.url|lower or ".webm" in media.file.url|lower %}
                            <video class="thumbnail" muted loop onclick="enlargeVideo('{{ media.file.url }}')">
                                <source src="{{ media.file.url }}" type="video/mp4">
                            </video>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </tbody>
    </table>
<div id="imageModal" class="modal" onclick="closeImageModal()">
    <img id="modalImage" style="display: block; max-width: 90%; max-height: 90%; margin: auto; margin-top: 5%;">
</div>

<div id="videoModal" class="modal" onclick="closeVideoModal()">
    <div class="modal-content" style="background: none; box-shadow: none; text-align: center;">
        <video id="modalVideo" style="max-width: 90%; max-height: 90%;" controls autoplay>
            <source id="modalVideoSource" src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
</div>



<script>
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const caseTypeCtx = document.getElementById('caseTypeChart').getContext('2d');

    const statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: {{ status_labels|safe }},
            datasets: [{
                data: {{ status_data|safe }},
                backgroundColor: ['#4BC0C0', '#FF6384', '#FFCE56']
            }]
        },
        options: {
            maintainAspectRatio: false,
            responsive: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Status',
                    color: 'white'
                },
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            }
        }
    });

    const caseTypeChart = new Chart(caseTypeCtx, {
        type: 'pie',
        data: {
            labels: {{ case_type_labels|safe }},
            datasets: [{
                data: {{ case_type_data|safe }},
                backgroundColor: ['#36A2EB', '#9966FF', '#FF6384', '#FFCE56', '#00C49F']
            }]
        },
        options: {
            plugins: {
                title: {
                    maintainAspectRatio: false,
                    responsive: false,
                    display: true,
                    text: 'Case Types',
                    color: 'white'
                },
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            }
        }
    });

    const countryCtx = document.getElementById('countryChart').getContext('2d');
    const countryChart = new Chart(countryCtx, {
        type: 'pie',
        data: {
            labels: {{ country_labels|safe }},
            datasets: [{
                data: {{ country_data|safe }},
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
            }]
        },
        options: {
            plugins: {
                title: {
                    maintainAspectRatio: false,
                    responsive: false,
                    display: true,
                    text: 'Countries',
                    color: 'white'
                },
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            }
        }
    });

    // MODAL HANDLERS
    function openModal(id) {
        document.getElementById('modal-' + id).style.display = 'block';
    }

    function closeModal(id) {
        document.getElementById('modal-' + id).style.display = 'none';
    }

    // IMAGE ENLARGE HANDLER
    function enlargeImage(src) {
        const modal = document.getElementById("imageModal");
        const img = document.getElementById("modalImage");
        img.src = src;
        modal.style.display = "block";
    }

    function closeImageModal() {
        document.getElementById("imageModal").style.display = "none";
    }

    // VIDEO PLAY ON CLICK
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("video.thumbnail").forEach(video => {
            video.addEventListener("click", () => {
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            });
        });
    });

    function enlargeVideo(src) {
    const modal = document.getElementById("videoModal");
    const video = document.getElementById("modalVideo");
    const source = document.getElementById("modalVideoSource");

    source.src = src;
    video.load();
    modal.style.display = "block";
    video.play();
}

function closeVideoModal() {
    const modal = document.getElementById("videoModal");
    const video = document.getElementById("modalVideo");
    modal.style.display = "none";
    video.pause();
    video.currentTime = 0;
}

document.addEventListener("DOMContentLoaded", function () {
    const filterForm = document.getElementById("filter-form");
    const filterElements = filterForm.querySelectorAll("select, input");

    filterElements.forEach(el => {
        el.addEventListener("change", () => {
            filterForm.submit();
        });
    });
});
</script>


</body>
</html>
